<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Expense Tracker | Dashboard</title>

    <style>
        /* ===== COLOR SCHEME (UNCHANGED) ===== */
        * {
            box-sizing: border-box;
            font-family: "Segoe UI", Tahoma, sans-serif;
        }

        body {
            margin: 0;
            min-height: 100vh;
            background: linear-gradient(135deg, #e6f4f1, #f4f7fb);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* ===== DASHBOARD ===== */
        .dashboard {
            width: 95%;
            max-width: 1200px;
            background: white;
            border-radius: 16px;
            padding: 28px 32px;
            box-shadow: 0 18px 40px rgba(0,0,0,0.08);
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #0f766e;
            margin: 0;
        }

        .logout {
            background: transparent;
            border: 1px solid #0f766e;
            color: #0f766e;
            padding: 8px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .logout:hover {
            background: #ecfdf5;
        }

        /* Budget Card */
        .budget-card {
            background: #ecfdf5;
            border-radius: 12px;
            padding: 22px;
            margin: 24px 0;
            text-align: center;
        }

        .budget-card h2 {
            color: #065f46;
            font-size: 30px;
            margin: 0;
        }

        /* Buttons */
        .actions {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .actions button {
            padding: 14px;
            background: #0f766e;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
        }

        .actions button:hover {
            background: #115e59;
        }

        /* Display Area */
        #dataArea {
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
            min-height: 220px;
            overflow-x: auto;
        }

        /* ===== MODALS ===== */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.45);
            display: none;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            width: 380px;
            padding: 24px;
            border-radius: 14px;
        }

        .modal-content h3 {
            color: #0f766e;
            margin-top: 0;
        }

        label {
            display: block;
            margin-top: 10px;
            font-size: 14px;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            margin-top: 4px;
            border-radius: 8px;
            border: 1px solid #cbd5e1;
        }

        textarea {
            resize: none;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 14px;
        }

        .modal-actions button {
            flex: 1;
        }

        .cancel {
            background: #e2e8f0;
            color: #334155;
        }

        .cancel:hover {
            background: #cbd5e1;
        }

        .message {
            margin-top: 10px;
            font-size: 14px;
        }
        .success {
            color: #065f46;
        }
        .error {
            color: #991b1b;
        }

        /* Table */
        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 10px;
            border-bottom: 1px solid #e5e7eb;
            text-align: left;
        }

        /* Delete button in table */
.table-delete-btn {
    background-color: #991b1b; /* red */
    color: #fff;
    border: none;
    border-radius: 4px;
    padding: 6px 10px;
    cursor: pointer;
    transition: background 0.3s ease;
}

.table-delete-btn:hover {
    background-color: #7f1d1d;
}

    </style>
</head>

<body>

<div class="dashboard">
    <div class="header">
        <h1>Expense Tracker</h1>
        <button class="logout" onclick="logout()">Logout</button>
    </div>

    <div class="budget-card">
        <h2 id="monthlyBudget">₹ 0</h2>
        <div>Current Monthly Budget</div>
    </div>

<!--    <div class="actions">-->
<!--        <button onclick="openModal('budgetModal')">Set Current Monthly Budget</button>-->
<!--        <button onclick="openModal('expenseModal')">Add Expense</button>-->
<!--        <button onclick="viewHistory()">View History of This Month</button>-->
<!--        <button onclick="viewMonthly()">View History of Every Month</button>-->
<!--    </div>-->

    <div class="actions">
        <button onclick="openModal('budgetModal')">Set Current Monthly Budget</button>
        <button onclick="openModal('expenseModal')">Add Expense</button>
        <button onclick="viewHistory()">View History of This Month</button>
        <button onclick="viewMonthly()">View History of Every Month</button>
        <button onclick="viewSavings()">View Savings</button>
    </div>


    <div id="dataArea">Select an option to view data.</div>
</div>

<!-- ===== BUDGET MODAL ===== -->
<div class="modal" id="budgetModal">
    <div class="modal-content">
        <h3>Set Monthly Budget</h3>
        <label>Amount (₹)</label>
        <input type="number" id="budgetInput">

        <div class="modal-actions">
            <button onclick="setBudget()">Okay</button>
            <button class="cancel" onclick="closeModal('budgetModal')">Cancel</button>
        </div>
        <div id="budgetMsg" class="message"></div>
    </div>
</div>

<!-- ===== EXPENSE MODAL ===== -->
<div class="modal" id="expenseModal">
    <div class="modal-content">
        <h3>Add Expense</h3>

        <label>Amount (₹)</label>
        <input type="number" id="expAmount">

        <label>Description</label>
        <textarea id="expDesc"></textarea>

        <label>Category</label>
        <select id="expCategory">
            <option>Food</option>
            <option>Education</option>
            <option>Self</option>
            <option>Travel</option>
            <option>Other</option>
        </select>

        <label>Mood</label>
        <select id="expMood">
            <option>Happy</option>
            <option>Neutral</option>
            <option>Sad</option>
        </select>

        <div class="modal-actions">
            <button onclick="addExpense()">Okay</button>
            <button class="cancel" onclick="closeModal('expenseModal')">Cancel</button>
        </div>
        <div id="expenseMsg" class="message"></div>
    </div>
</div>

<script>
    /* ===== AUTH CHECK ===== */
    const userId = localStorage.getItem("userId");
    if (!userId) {
        window.location.href = "login.html";
    }

    /* ===== UTIL ===== */
    function openModal(id) {
        document.getElementById(id).style.display = "flex";
    }
    function closeModal(id) {
        document.getElementById(id).style.display = "none";
    }
    function logout() {
        localStorage.clear();
        window.location.href = "login.html";
    }

    /* ===== BUDGET ===== */
    function fetchBudget() {
        fetch(`http://localhost:8081/get-details/${userId}`)
            .then(res => res.json())
            .then(data => {
            remainingBudget = Number(data.newmonthlyBudget);
                document.getElementById("monthlyBudget").innerText = "₹ " + data.newmonthlyBudget;
                if(data.newmonthlyBudget <= 0){
                    alert("You cannot do this!");
                }
            });
    }

    function setBudget() {
        const amount = document.getElementById("budgetInput").value;

        fetch("http://localhost:8081/setBudget", {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({ userId: userId, monthlyBudget: amount })
        })
        .then(res => res.text())
        .then(msg => {
            document.getElementById("budgetMsg").innerText = msg;
            document.getElementById("budgetMsg").className = "message success";
            fetchBudget();
            setTimeout(() => closeModal("budgetModal"), 1200);
        });
    }

    /* ===== EXPENSE ===== */


function addExpense() {
    const amountInput = document.getElementById("expAmount");
    const amount = Number(amountInput.value);
    const msgDiv = document.getElementById("expenseMsg");

    // BASIC VALIDATION
    if (amountInput.value.trim() === "") {
        msgDiv.innerText = "Enter the amount";
        msgDiv.className = "message error";
        return;
    }

    if (isNaN(amount) || amount <= 0) {
        msgDiv.innerText = "Enter a valid amount";
        msgDiv.className = "message error";
        return;
    }

    // BUDGET CHECK
    if (isNaN(remainingBudget)) {
        alert("Budget not loaded yet. Please wait.");
        return;
    }

    if (amount > remainingBudget) {
        alert("This is out of budget");
        return;
    }

    // API CALL
    fetch("http://localhost:8081/expense", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            id: userId,
            expenseAmount: amount,
            description: document.getElementById("expDesc").value,
            category: document.getElementById("expCategory").value,
            mood: document.getElementById("expMood").value
        })
    })
    .then(res => res.text())
    .then(msg => {
        msgDiv.innerText = msg;

        if (msg.toLowerCase().includes("noted")) {
            msgDiv.className = "message success";
            fetchBudget(); // refresh remaining budget
            setTimeout(() => closeModal("expenseModal"), 1200);
        } else {
            msgDiv.className = "message error";
        }
    })
    .catch(() => {
        msgDiv.innerText = "Server error";
        msgDiv.className = "message error";
    });
}



    /* ===== HISTORY ===== */

<!--function viewHistory() {-->
<!--    fetch(`http://localhost:8081/histories/${userId}`)-->
<!--        .then(res => res.json())-->
<!--        .then(data => {-->
<!--            let html = "<table><tr><th>Amount</th><th>Description</th><th>Category</th><th>Mood</th></tr>";-->
<!--            data.forEach(e => {-->
<!--                html += `<tr>-->
<!--                    <td>₹${e.expenseAmount}</td>-->
<!--                    <td>${e.description}</td>-->
<!--                    <td>${e.category}</td>-->
<!--                    <td>${e.mood}</td>-->
<!--                </tr>`;-->
<!--            });-->
<!--            html += "</table>";-->
<!--            document.getElementById("dataArea").innerHTML = html;-->
<!--        });-->
<!--}-->

function viewHistory() {
    fetch(`http://localhost:8081/histories/${userId}`)
        .then(res => res.json())
        .then(data => {
            let html = "<table><tr><th>Amount</th><th>Description</th><th>Category</th><th>Mood</th><th>Action</th></tr>";
            data.forEach(e => {
                html += `<tr>
                    <td>₹${e.expenseAmount}</td>
                    <td>${e.description}</td>
                    <td>${e.category}</td>
                    <td>${e.mood}</td>
                    <td><button onclick="deleteExpense(${e.id})" style="background:#991b1b; color:#fff; padding:4px 8px; border:none; border-radius:4px; cursor:pointer;">Delete</button></td>
                </tr>`;
            });
            html += "</table>";
            document.getElementById("dataArea").innerHTML = html;
        });
}

function deleteExpense(expenseId) {
    if (!confirm("Are you sure you want to delete this expense?")) return;

    fetch(`http://localhost:8081/delete/${expenseId}`, {
        method: "DELETE"
    })
    .then(res => {
        if (res.ok) {
            alert("Expense deleted successfully!");
            fetchBudget();   // refresh budget
            viewHistory();   // refresh table
        } else {
            alert("Error deleting expense");
        }
    })
    .catch(() => alert("Server error"));
}




    function viewMonthly() {
        fetch(`http://localhost:8081/monthly-summary/${userId}`)
            .then(res => res.json())
            .then(data => {
                let html = "<table><tr><th>Month</th><th>Total Expense</th></tr>";
                data.forEach(m => {
                    html += `<tr><td>${m.month}</td><td>₹${m.total}</td></tr>`;
                });
                html += "</table>";
                document.getElementById("dataArea").innerHTML = html;
            });
    }

function viewSavings() {
    fetch(`http://localhost:8081/saving/${id}`)
        .then(res => res.json())
        .then(data => {

            const monthNames = [
                "January","February","March","April","May","June",
                "July","August","September","October","November","December"
            ];

            let html = `
                <table>
                    <tr>
                        <th>Month</th>
                        <th>Year</th>
                        <th>Saved Amount</th>
                    </tr>
                    <tr>
                        <td>${monthNames[data.month - 1]}</td>
                        <td>${data.year}</td>
                        <td>₹ ${data.saving}</td>
                    </tr>
                </table>
            `;

            document.getElementById("dataArea").innerHTML = html;
        })
        .catch(() => {
            document.getElementById("dataArea").innerText =
                "Unable to fetch savings data.";
        });
}

    /* Initial Load */
    fetchBudget();
</script>

</body>
</html>